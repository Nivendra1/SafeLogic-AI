#!/usr/bin/env python3

import argparse
from safelogic_engine import check_safety
from llm_interface import LLMInterface
import re


def extract_boolean_expression(structured_text: str) -> str:
    match = re.search(r":=\s*(.*?);", structured_text, re.DOTALL)
    if not match:
        raise ValueError("Could not extract boolean expression.")
    expression = match.group(1).strip()

    expression = re.sub(r"\bAND\b", "and", expression)
    expression = re.sub(r"\bOR\b", "or", expression)
    expression = re.sub(r"\bNOT\b", "not", expression)

    return expression


def render_report(expression: str, result: dict):
    print("\n==============================")
    print("SAFELOGIC SAFETY AUDIT REPORT")
    print("==============================\n")

    print(f"Expression Evaluated: {expression}")
    print(f"Status: {result.get('status')}")
    print(f"Risk Level: {result.get('risk_level')}")

    if result.get("reason"):
        print("\nReason:")
        print(result["reason"])

    if result.get("counterexample"):
        print("\nCounterexample:")
        print(result["counterexample"])


def main():
    parser = argparse.ArgumentParser(description="SafeLogic CLI")
    parser.add_argument("--generate", type=str, help="Generate structured text from description")
    parser.add_argument("--check", type=str, help="Check boolean expression directly")

    args = parser.parse_args()

    # DIRECT CHECK MODE
    if args.check:
        expression = args.check.lower()
        result = check_safety(expression)
        render_report(expression, result)
        return

    # GENERATE MODE
    if args.generate:
        llm = LLMInterface()
        structured_text = llm.generate_structured_text(args.generate)

        print("\nGenerated IEC 61131-3 Structured Text:\n")
        print(structured_text)

        expression = extract_boolean_expression(structured_text)
        result = check_safety(expression)
        render_report(expression, result)
        return

    parser.print_help()


if __name__ == "__main__":
    main()
